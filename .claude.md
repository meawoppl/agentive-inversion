# Claude Development Context

## Project Overview

Agentive Inversion is a self-updating todo list application built entirely in Rust. It automatically aggregates tasks from multiple Gmail accounts and Google Workspace calendars.

## Architecture

### Workspace Structure

This is a Cargo workspace with four main crates:

1. **frontend/** - Yew WebAssembly SPA
2. **backend/** - Axum REST API server
3. **polling-services/** - Background polling services for Gmail/Calendar
4. **shared/** - Common types and models

### Technology Decisions

- **Frontend**: Yew 0.21 chosen for its strong type safety and Rust ecosystem integration
- **Backend**: Axum for its performance and ergonomic async/await support
- **Database**: Neon SQL (PostgreSQL) with Diesel ORM for type-safe queries
- **Async Runtime**: Tokio for all async operations
- **OAuth**: yup-oauth2 for Google API authentication

## Development Guidelines

### Code Style

- Follow Rust standard formatting (`cargo fmt`)
- Use `clippy` for linting (`cargo clippy`)
- Prefer explicit error handling over `.unwrap()` or `.expect()`
- Use `thiserror` for custom error types
- Use `anyhow` for application-level error handling
- Document public APIs with `///` doc comments

### Database Interactions

- All database operations must use Diesel ORM
- Migrations are in `/migrations` directory
- Use `diesel migration generate` for new migrations
- Always test migrations with `diesel migration run` and `diesel migration redo`

### API Design

- RESTful endpoints under `/api/*`
- Use JSON for all request/response bodies
- Implement proper HTTP status codes
- Include CORS headers for frontend communication
- Use tower middleware for logging, auth, and error handling

### Frontend Patterns

- Component-based architecture with Yew
- Use `yew::function_component` for new components
- State management via Yew contexts
- API calls through gloo-net
- Routing with yew-router

### Testing

- Unit tests in each module (`#[cfg(test)]`)
- Integration tests in `tests/` directory
- Frontend tests with wasm-pack
- Use `#[tokio::test]` for async tests
- Mock external APIs in tests

### Error Handling

```rust
// Backend
use anyhow::{Context, Result};
use thiserror::Error;

#[derive(Error, Debug)]
pub enum AppError {
    #[error("Database error: {0}")]
    Database(#[from] diesel::result::Error),
    #[error("Not found: {0}")]
    NotFound(String),
}

// Frontend
use gloo_net::Error as NetworkError;
```

### Environment Variables

Required variables in `.env`:
- `DATABASE_URL` - PostgreSQL connection string
- `GOOGLE_CLIENT_ID` - Google OAuth client ID
- `GOOGLE_CLIENT_SECRET` - Google OAuth client secret
- `GOOGLE_REDIRECT_URI` - OAuth redirect URI
- `POLLING_INTERVAL_SECONDS` - Default polling interval

### Polling Services

- Each poller runs in its own tokio task
- Configurable polling intervals per source
- Graceful shutdown on SIGTERM
- Exponential backoff on API errors
- Store last poll timestamp in database

### Security Considerations

- Store OAuth tokens encrypted in database
- Use HTTPS in production
- Validate all user inputs
- Sanitize data from external APIs
- Rate limit API endpoints
- Never log sensitive credentials

## Common Tasks

### Adding a New API Endpoint

1. Define route in `backend/src/routes.rs`
2. Implement handler in appropriate module
3. Add tests for the endpoint
4. Update API documentation in README

### Adding a New Database Table

1. `diesel migration generate table_name`
2. Write `up.sql` and `down.sql`
3. Run `diesel migration run`
4. Update models in `shared/src/models.rs`
5. Add Diesel schema to `backend/src/schema.rs`

### Adding a New Frontend Component

1. Create component in `frontend/src/components/`
2. Define props interface
3. Implement render logic
4. Add to parent component or router
5. Style with CSS (if needed)

### Integrating a New External Service

1. Add API client to `polling-services/src/`
2. Implement authentication flow
3. Create polling task with tokio
4. Add database models for source
5. Implement task extraction logic
6. Add configuration options

## Build & Deploy

### Local Development

```bash
# Backend
cd backend && cargo run

# Frontend
cd frontend && trunk serve

# Polling services
cd polling-services && cargo run
```

### Production Build

```bash
# Build all workspace members
cargo build --release --workspace

# Build frontend
cd frontend && trunk build --release
```

### Database Migrations

```bash
# Run migrations
diesel migration run

# Rollback last migration
diesel migration revert

# Regenerate schema
diesel print-schema > backend/src/schema.rs
```

## Dependencies Management

### Adding Dependencies

- Add to workspace dependencies in root `Cargo.toml` when shared
- Add crate-specific deps in respective `Cargo.toml`
- Keep versions consistent across workspace
- Prefer workspace dependencies for common crates

### Version Constraints

- Use `^` for patch updates (e.g., `^1.2.3` = `>=1.2.3, <2.0.0`)
- Pin exact versions for critical security dependencies
- Update dependencies regularly with `cargo update`

## Testing Strategy

### Unit Tests
- Test business logic in isolation
- Mock external dependencies
- Aim for >80% code coverage

### Integration Tests
- Test API endpoints end-to-end
- Use test database
- Clean up test data after each test

### E2E Tests (Future)
- Selenium-based browser tests
- Test complete user workflows
- Run in CI pipeline

## CI/CD Pipeline

GitHub Actions runs on:
- Every push to any branch
- Every pull request
- Scheduled nightly builds

Pipeline steps:
1. Checkout code
2. Cache dependencies
3. Run `cargo fmt --check`
4. Run `cargo clippy`
5. Run `cargo test --workspace`
6. Build frontend with trunk
7. Build backend release binary
8. Run integration tests

## Troubleshooting

### Common Issues

**Frontend won't build:**
- Ensure `wasm32-unknown-unknown` target is installed
- Check trunk is up to date
- Clear trunk cache with `trunk clean`

**Database connection fails:**
- Verify `DATABASE_URL` in `.env`
- Check PostgreSQL is running
- Ensure migrations are up to date

**OAuth errors:**
- Verify Google Cloud credentials
- Check redirect URI matches configuration
- Ensure APIs are enabled in GCP

**Polling service crashes:**
- Check API rate limits
- Verify token refresh logic
- Review error logs for specific API errors

## Resources

- [Yew Documentation](https://yew.rs/)
- [Axum Documentation](https://docs.rs/axum/)
- [Diesel Documentation](https://diesel.rs/)
- [Trunk Documentation](https://trunkrs.dev/)
- [Gmail API Reference](https://developers.google.com/gmail/api)
- [Google Calendar API Reference](https://developers.google.com/calendar)

## Future Enhancements

- Real-time WebSocket updates
- Natural language processing for task extraction
- Task prioritization ML model
- Mobile app (Tauri)
- Browser extension
- Slack/Discord integrations
- Task templates
- Collaborative features
