name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache diesel_cli
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/diesel
          key: ${{ runner.os }}-diesel-cli

      - name: Install diesel_cli
        run: command -v diesel || cargo install diesel_cli --no-default-features --features postgres

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "::warning::DATABASE_URL secret not set, skipping migrations"
            exit 0
          fi
          diesel migration run

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: run-migrations
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-deploy-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build backend
        run: cargo build --release --package backend

      - name: Deploy placeholder
        run: |
          echo "Backend deployment would happen here"
          echo "Binary is at: target/release/backend"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: run-migrations
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-frontend-deploy-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache trunk
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/trunk
          key: ${{ runner.os }}-trunk

      - name: Install Trunk
        run: command -v trunk || cargo install trunk

      - name: Build frontend
        run: cd crates/frontend && trunk build --release

      - name: Deploy placeholder
        run: |
          echo "Frontend deployment would happen here"
          echo "Built files are in: crates/frontend/dist/"
